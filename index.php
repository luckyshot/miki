<?php
/*!

                          iiii  kkkkkkkk             iiii  
                         i::::i k::::::k            i::::i 
                          iiii  k::::::k             iiii  
                                k::::::k                   
   mmmmmmm    mmmmmmm   iiiiiii  k:::::k    kkkkkkkiiiiiii 
 mm:::::::m  m:::::::mm i:::::i  k:::::k   k:::::k i:::::i 
m::::::::::mm::::::::::m i::::i  k:::::k  k:::::k   i::::i 
m::::::::::::::::::::::m i::::i  k:::::k k:::::k    i::::i 
m:::::mmm::::::mmm:::::m i::::i  k::::::k:::::k     i::::i 
m::::m   m::::m   m::::m i::::i  k:::::::::::k      i::::i 
m::::m   m::::m   m::::m i::::i  k:::::::::::k      i::::i 
m::::m   m::::m   m::::m i::::i  k::::::k:::::k     i::::i 
m::::m   m::::m   m::::mi::::::ik::::::k k:::::k   i::::::i
m::::m   m::::m   m::::mi::::::ik::::::k  k:::::k  i::::::i
m::::m   m::::m   m::::mi::::::ik::::::k   k:::::k i::::::i
mmmmmm   mmmmmm   mmmmmmiiiiiiiikkkkkkkk    kkkkkkkiiiiiiii

                                             by Xavi Esteve


	Miki is the smallest wiki system ever, just one file.
	 - One single PHP file (and an htaccess)
	 - No database needed
	 - CSS and JS files generated automatically
	 - Markdown language
	 - No images
	 - Super fast, just one server request
	 
	============= Setup ==============
	1. Place index.php and .htaccess in an empty folder
	2. Open index.php in a text editor and customize the options below
	3. Open htaccess and write your folder path
	4. Bookmark /miki/$apppass and always use that URL when accessing Miki for the first time
	
	=========== Formatting ===========
	Same as Markdown:
	http://daringfireball.net/projects/markdown/syntax	

TODO: Folder to be the password (allows multiple users)
TODO: manifest to cache offline CSS and JS
TODO: optimise all file list
TODO: move to JS as much PHP as possible so that file is super small
TODO: htaccess to be autogenerated too
TODO: option to forbid direct .txt files access
TODO: Add night theme feature activated automatically at night

*/
session_start();
class Miki {
	
	/****************************************************************************************
	 * Basic config
	 */
	private $appname = 'Miki';
	private $appversion = '2.0.2';
	private $apppass = 'JHGFkJYfbDYGbingNjhGBJFjfbgJBFJfgjbHFjHFjfkuwtyknGDFcFDSwxEWzaZWeqwQSdvFgbIplIOiMjmbhVGFFuHGGTRDeEDFyTctdgfDVtEScescTrdvFBfuYGNJgy538gjHBGfBHgfbHgBFjHGnkJmhJkjpkplPlPoPlpKpLPlpKlJKNKnKnhjHBjhGsaWAqaWSZxCXVCbvBVnBnmnmnmNKJKjJOIuUgYFteRsRdFYgUhuHkJ';
	private $extension = 'txt';
	private $maxlength = 10000; // file max characters
	private $csscachetime = 86400; // 3600 = 1 hour, 86400 = 1 day, 604800 = 1 week, 18144000 = 1 month
	
	/* Production */
	private $url = 'http://example.com/miki'; // no trailing slash
	private $apppath = '/htdocs/miki'; // no trailing slash

	
	
	
	
	
	
	
	
	/****************************************************************************************
	 * You are done, no more config needed :)
	 */
	 
	private $page;
	private $breadcrumb = array();
	private $css = '/* Miki CSS file */
html {background: #FBFBFB;}
.hide {display:none;}
body {font-family:Georgia, serif;margin: 0 auto 20px;max-width:960px;padding: 0 7%;}
	.bc {color: #CCC;margin: 0;padding: 1px 20px;margin: 0 -20px;opacity:0.6;transition: opacity 0.5s ease;-webkit-transition: opacity 0.5s ease;height: 1.45em;}
		.bc:hover {opacity:1;background:#fff;}
	.bc a {color:#666;font-size:66%;font-weight:100;text-decoration:none;}
		.bc .start {color:#c00;margin-top: 0;font-family: sans-serif;font-weight: bold;}
		.bc .start:hover {color:#c00;}
	#box-view {font-size: 1em;line-height: 1.66em;}
		#box-view a {color:#0085d5;text-decoration:none;}
		#box-view a:hover {background:#fffacb;text-decoration:underline;}
		.title {color: #C00;font-size: 4em;line-height: 1.33em;margin: .3em 0;text-shadow: 0 3px 4px #CCC;}
		h2,h3,h4,h5,h6 {margin: 2em 0 0.1em;padding-bottom: .1em;}
		h2 {border-bottom: 1px solid #eee;box-shadow: 0 1px 3px #EEE;color: #333;padding-bottom:.33em}
		h3 {color: #c00;text-transform: uppercase;font-family:\'Trebuchet MS\',sans-serif;font-size:1em;}
		h4 {color:#000;}
		h5 {font-family:\'Trebuchet MS\',sans-serif;text-transform:uppercase;font-size: .7em;letter-spacing: .2em;}
		h5,h6 {color:#666;}
			
	/*#box-edit {border-top:1px dashed #eee;height:2em;overflow:hidden;padding:5px 0;margin-top:50px;}*/
	
		#box-edit .edit,input[type=submit] {display:block;border:none;color: #fff;cursor: pointer;padding: 2em 0.5em 2em 2em;opacity: 0.3;font-size: 66%;position: fixed;top: 33%;right: 0;background: #c00;border-top-left-radius: 100%;border-bottom-left-radius:100%;-webkit-appearance:none;}
			#box-edit .edit:hover {opacity:0.9}
			
		textarea {border:none;height:500px;font-family:Georgia,sans-serif;font-size:1em;line-height:1.66em;padding:.66em;width:100%;}

		pre {background: #EEE;color: #008200;overflow-x: scroll;padding: .33em .66em;line-height: 1.33em;border-radius: .5em;tab-size:2;border: 1px solid #DDD;}
		blockquote {font-style:italic;font-size:.95em;color:#666;padding:.66em 1em;margin:0 .66em;}
		input[type=submit] {/*border: none;background: #C00;border-radius: 1em;padding: .66em;width: 98%;opacity: 0.3;font-size: 1em;font-family: Georgia,serif;color: white;font-weight: 900;cursor:pointer;*/}
		
		.allfiles {list-style:none;padding:0;}
			.allfiles li {display: inline;}
				.allfiles a {padding: 0 1em 1em 0;text-decoration: none;font-size: 80%;color: #666;}

/* Responsive Design */
@media screen and (max-width:520px) { /* Mobile */
	body {font-size:80%;padding: 0 3px;}
	#box-edit textarea {height:150px;}
}
';
private $js = '
// showdown.js -- A javascript port of Markdown.
// Copyright (c) 2007 John Fraser.
// Redistributable under a BSD-style open source license.
var Showdown={extensions:{}},forEach=Showdown.forEach=function(a,b){if(typeof a.forEach=="function")a.forEach(b);else{var c,d=a.length;for(c=0;c<d;c++)b(a[c],c,a)}},stdExtName=function(a){return a.replace(/[_-]||\\s/g,"").toLowerCase()};Showdown.converter=function(a){var b,c,d,e=0,f=[],g=[];if(typeof module!="undefind"&&typeof exports!="undefined"&&typeof require!="undefind"){var h=require("fs");if(h){var i=h.readdirSync((__dirname||".")+"/extensions").filter(function(a){return~a.indexOf(".js")}).map(function(a){return a.replace(/\\.js$/,"")});Showdown.forEach(i,function(a){var b=stdExtName(a);Showdown.extensions[b]=require("./extensions/"+a)})}}this.makeHtml=function(a){return b={},c={},d=[],a=a.replace(/~/g,"~T"),a=a.replace(/\\$/g,"~D"),a=a.replace(/\\r\\n/g,"\\n"),a=a.replace(/\\r/g,"\\n"),a="\\n\\n"+a+"\\n\\n",a=M(a),a=a.replace(/^[ \\t]+$/mg,""),Showdown.forEach(f,function(b){a=k(b,a)}),a=z(a),a=m(a),a=l(a),a=o(a),a=K(a),a=a.replace(/~D/g,"$$"),a=a.replace(/~T/g,"~"),Showdown.forEach(g,function(b){a=k(b,a)}),a};if(a&&a.extensions){var j=this;Showdown.forEach(a.extensions,function(a){typeof a=="string"&&(a=Showdown.extensions[stdExtName(a)]);if(typeof a!="function")throw"Extension \'"+a+"\' could not be loaded.  It was either not found or is not a valid extension.";Showdown.forEach(a(j),function(a){a.type?a.type==="language"||a.type==="lang"?f.push(a):(a.type==="output"||a.type==="html")&&g.push(a):g.push(a)})})}var k=function(a,b){if(a.regex){var c=new RegExp(a.regex,"g");return b.replace(c,a.replace)}if(a.filter)return a.filter(b)},l=function(a){return a+="~0",a=a.replace(/^[ ]{0,3}\\[(.+)\\]:[ \\t]*\\n?[ \\t]*<?(\\S+?)>?[ \\t]*\\n?[ \\t]*(?:(\\n*)["(](.+?)[")][ \\t]*)?(?:\\n+|(?=~0))/gm,function(a,d,e,f,g){return d=d.toLowerCase(),b[d]=G(e),f?f+g:(g&&(c[d]=g.replace(/"/g,"&quot;")),"")}),a=a.replace(/~0/,""),a},m=function(a){a=a.replace(/\\n/g,"\\n\\n");var b="p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del|style|section|header|footer|nav|article|aside",c="p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|style|section|header|footer|nav|article|aside";return a=a.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\\b[^\\r]*?\\n<\\/\\2>[ \\t]*(?=\\n+))/gm,n),a=a.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|style|section|header|footer|nav|article|aside)\\b[^\\r]*?<\\/\\2>[ \\t]*(?=\\n+)\\n)/gm,n),a=a.replace(/(\\n[ ]{0,3}(<(hr)\\b([^<>])*?\\/?>)[ \\t]*(?=\\n{2,}))/g,n),a=a.replace(/(\\n\\n[ ]{0,3}<!(--[^\\r]*?--\\s*)+>[ \\t]*(?=\\n{2,}))/g,n),a=a.replace(/(?:\\n\\n)([ ]{0,3}(?:<([?%])[^\\r]*?\\2>)[ \\t]*(?=\\n{2,}))/g,n),a=a.replace(/\\n\\n/g,"\\n"),a},n=function(a,b){var c=b;return c=c.replace(/\\n\\n/g,"\\n"),c=c.replace(/^\\n/,""),c=c.replace(/\\n+$/g,""),c="\\n\\n~K"+(d.push(c)-1)+"K\\n\\n",c},o=function(a){a=v(a);var b=A("<hr />");return a=a.replace(/^[ ]{0,2}([ ]?\\*[ ]?){3,}[ \\t]*$/gm,b),a=a.replace(/^[ ]{0,2}([ ]?\\-[ ]?){3,}[ \\t]*$/gm,b),a=a.replace(/^[ ]{0,2}([ ]?\\_[ ]?){3,}[ \\t]*$/gm,b),a=x(a),a=y(a),a=E(a),a=m(a),a=F(a),a},p=function(a){return a=B(a),a=q(a),a=H(a),a=t(a),a=r(a),a=I(a),a=G(a),a=D(a),a=a.replace(/  +\\n/g," <br />\\n"),a},q=function(a){var b=/(<[a-z\\/!$]("[^"]*"|\'[^\']*\'|[^\'">])*>|<!(--.*?--\\s*)+>)/gi;return a=a.replace(b,function(a){var b=a.replace(/(.)<\\/?code>(?=.)/g,"$1`");return b=N(b,"\\\\`*_"),b}),a},r=function(a){return a=a.replace(/(\\[((?:\\[[^\\]]*\\]|[^\\[\\]])*)\\][ ]?(?:\\n[ ]*)?\\[(.*?)\\])()()()()/g,s),a=a.replace(/(\\[((?:\\[[^\\]]*\\]|[^\\[\\]])*)\\]\\([ \\t]*()<?(.*?(?:\\(.*?\\).*?)?)>?[ \\t]*(([\'"])(.*?)\\6[ \\t]*)?\\))/g,s),a=a.replace(/(\\[([^\\[\\]]+)\\])()()()()()/g,s),a},s=function(a,d,e,f,g,h,i,j){j==undefined&&(j="");var k=d,l=e,m=f.toLowerCase(),n=g,o=j;if(n==""){m==""&&(m=l.toLowerCase().replace(/ ?\\n/g," ")),n="#"+m;if(b[m]!=undefined)n=b[m],c[m]!=undefined&&(o=c[m]);else{if(!(k.search(/\\(\\s*\\)$/m)>-1))return k;n=""}}n=N(n,"*_");var p=\'<a href="\'+n+\'"\';return o!=""&&(o=o.replace(/"/g,"&quot;"),o=N(o,"*_"),p+=\' title="\'+o+\'"\'),p+=">"+l+"</a>",p},t=function(a){return a=a.replace(/(!\\[(.*?)\\][ ]?(?:\\n[ ]*)?\\[(.*?)\\])()()()()/g,u),a=a.replace(/(!\\[(.*?)\\]\\s?\\([ \\t]*()<?(\\S+?)>?[ \\t]*(([\'"])(.*?)\\6[ \\t]*)?\\))/g,u),a},u=function(a,d,e,f,g,h,i,j){var k=d,l=e,m=f.toLowerCase(),n=g,o=j;o||(o="");if(n==""){m==""&&(m=l.toLowerCase().replace(/ ?\\n/g," ")),n="#"+m;if(b[m]==undefined)return k;n=b[m],c[m]!=undefined&&(o=c[m])}l=l.replace(/"/g,"&quot;"),n=N(n,"*_");var p=\'<img src="\'+n+\'" alt="\'+l+\'"\';return o=o.replace(/"/g,"&quot;"),o=N(o,"*_"),p+=\' title="\'+o+\'"\',p+=" />",p},v=function(a){function b(a){return a.replace(/[^\\w]/g,"").toLowerCase()}return a=a.replace(/^(.+)[ \\t]*\\n=+[ \\t]*\\n+/gm,function(a,c){return A(\'<h1 id="\'+b(c)+\'">\'+p(c)+"</h1>")}),a=a.replace(/^(.+)[ \\t]*\\n-+[ \\t]*\\n+/gm,function(a,c){return A(\'<h2 id="\'+b(c)+\'">\'+p(c)+"</h2>")}),a=a.replace(/^(\\#{1,6})[ \\t]*(.+?)[ \\t]*\\#*\\n+/gm,function(a,c,d){var e=c.length;return A("<h"+e+\' id="\'+b(d)+\'">\'+p(d)+"</h"+e+">")}),a},w,x=function(a){a+="~0";var b=/^(([ ]{0,3}([*+-]|\\d+[.])[ \\t]+)[^\\r]+?(~0|\\n{2,}(?=\\S)(?![ \\t]*(?:[*+-]|\\d+[.])[ \\t]+)))/gm;return e?a=a.replace(b,function(a,b,c){var d=b,e=c.search(/[*+-]/g)>-1?"ul":"ol";d=d.replace(/\\n{2,}/g,"\\n\\n\\n");var f=w(d);return f=f.replace(/\\s+$/,""),f="<"+e+">"+f+"</"+e+">\\n",f}):(b=/(\\n\\n|^\\n?)(([ ]{0,3}([*+-]|\\d+[.])[ \\t]+)[^\\r]+?(~0|\\n{2,}(?=\\S)(?![ \\t]*(?:[*+-]|\\d+[.])[ \\t]+)))/g,a=a.replace(b,function(a,b,c,d){var e=b,f=c,g=d.search(/[*+-]/g)>-1?"ul":"ol",f=f.replace(/\\n{2,}/g,"\\n\\n\\n"),h=w(f);return h=e+"<"+g+">\\n"+h+"</"+g+">\\n",h})),a=a.replace(/~0/,""),a};w=function(a){return e++,a=a.replace(/\\n{2,}$/,"\\n"),a+="~0",a=a.replace(/(\\n)?(^[ \\t]*)([*+-]|\\d+[.])[ \\t]+([^\\r]+?(\\n{1,2}))(?=\\n*(~0|\\2([*+-]|\\d+[.])[ \\t]+))/gm,function(a,b,c,d,e){var f=e,g=b,h=c;return g||f.search(/\\n{2,}/)>-1?f=o(L(f)):(f=x(L(f)),f=f.replace(/\\n$/,""),f=p(f)),"<li>"+f+"</li>\\n"}),a=a.replace(/~0/g,""),e--,a};var y=function(a){return a+="~0",a=a.replace(/(?:\\n\\n|^)((?:(?:[ ]{4}|\\t).*\\n+)+)(\\n*[ ]{0,3}[^ \\t\\n]|(?=~0))/g,function(a,b,c){var d=b,e=c;return d=C(L(d)),d=M(d),d=d.replace(/^\\n+/g,""),d=d.replace(/\\n+$/g,""),d="<pre><code>"+d+"\\n</code></pre>",A(d)+e}),a=a.replace(/~0/,""),a},z=function(a){return a+="~0",a=a.replace(/(?:^|\\n)```(.*)\\n([\\s\\S]*?)\\n```/g,function(a,b,c){var d=b,e=c;return e=C(e),e=M(e),e=e.replace(/^\\n+/g,""),e=e.replace(/\\n+$/g,""),e="<pre><code"+(d?\' class="\'+d+\'"\':"")+">"+e+"\\n</code></pre>",A(e)}),a=a.replace(/~0/,""),a},A=function(a){return a=a.replace(/(^\\n+|\\n+$)/g,""),"\\n\\n~K"+(d.push(a)-1)+"K\\n\\n"},B=function(a){return a=a.replace(/(^|[^\\\\])(`+)([^\\r]*?[^`])\\2(?!`)/gm,function(a,b,c,d,e){var f=d;return f=f.replace(/^([ \\t]*)/g,""),f=f.replace(/[ \\t]*$/g,""),f=C(f),b+"<code>"+f+"</code>"}),a},C=function(a){return a=a.replace(/&/g,"&amp;"),a=a.replace(/</g,"&lt;"),a=a.replace(/>/g,"&gt;"),a=N(a,"*_{}[]\\\\",!1),a},D=function(a){return a=a.replace(/(\\*\\*|__)(?=\\S)([^\\r]*?\\S[*_]*)\\1/g,"<strong>$2</strong>"),a=a.replace(/(\\*|_)(?=\\S)([^\\r]*?\\S)\\1/g,"<em>$2</em>"),a},E=function(a){return a=a.replace(/((^[ \\t]*>[ \\t]?.+\\n(.+\\n)*\\n*)+)/gm,function(a,b){var c=b;return c=c.replace(/^[ \\t]*>[ \\t]?/gm,"~0"),c=c.replace(/~0/g,""),c=c.replace(/^[ \\t]+$/gm,""),c=o(c),c=c.replace(/(^|\\n)/g,"$1  "),c=c.replace(/(\\s*<pre>[^\\r]+?<\\/pre>)/gm,function(a,b){var c=b;return c=c.replace(/^  /mg,"~0"),c=c.replace(/~0/g,""),c}),A("<blockquote>\\n"+c+"\\n</blockquote>")}),a},F=function(a){a=a.replace(/^\\n+/g,""),a=a.replace(/\\n+$/g,"");var b=a.split(/\\n{2,}/g),c=[],e=b.length;for(var f=0;f<e;f++){var g=b[f];g.search(/~K(\\d+)K/g)>=0?c.push(g):g.search(/\\S/)>=0&&(g=p(g),g=g.replace(/^([ \\t]*)/g,"<p>"),g+="</p>",c.push(g))}e=c.length;for(var f=0;f<e;f++)while(c[f].search(/~K(\\d+)K/)>=0){var h=d[RegExp.$1];h=h.replace(/\\$/g,"$$$$"),c[f]=c[f].replace(/~K\\d+K/,h)}return c.join("\\n\\n")},G=function(a){return a=a.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\\w+);)/g,"&amp;"),a=a.replace(/<(?![a-z\\/?\\$!])/gi,"&lt;"),a},H=function(a){return a=a.replace(/\\\\(\\\\)/g,O),a=a.replace(/\\\\([`*_{}\\[\\]()>#+-.!])/g,O),a},I=function(a){return a=a.replace(/<((https?|ftp|dict):[^\'">\\s]+)>/gi,\'<a href="$1">$1</a>\'),a=a.replace(/<(?:mailto:)?([-.\\w]+\\@[-a-z0-9]+(\\.[-a-z0-9]+)*\\.[a-z]+)>/gi,function(a,b){return J(K(b))}),a},J=function(a){var b=[function(a){return"&#"+a.charCodeAt(0)+";"},function(a){return"&#x"+a.charCodeAt(0).toString(16)+";"},function(a){return a}];return a="mailto:"+a,a=a.replace(/./g,function(a){if(a=="@")a=b[Math.floor(Math.random()*2)](a);else if(a!=":"){var c=Math.random();a=c>.9?b[2](a):c>.45?b[1](a):b[0](a)}return a}),a=\'<a href="\'+a+\'">\'+a+"</a>",a=a.replace(/">.+:/g,\'">\'),a},K=function(a){return a=a.replace(/~E(\\d+)E/g,function(a,b){var c=parseInt(b);return String.fromCharCode(c)}),a},L=function(a){return a=a.replace(/^(\\t|[ ]{1,4})/gm,"~0"),a=a.replace(/~0/g,""),a},M=function(a){return a=a.replace(/\\t(?=\\t)/g,"    "),a=a.replace(/\\t/g,"~A~B"),a=a.replace(/~B(.+?)~A/g,function(a,b,c){var d=b,e=4-d.length%4;for(var f=0;f<e;f++)d+=" ";return d}),a=a.replace(/~A/g,"    "),a=a.replace(/~B/g,""),a},N=function(a,b,c){var d="(["+b.replace(/([\\[\\]\\\\])/g,"\\\\$1")+"])";c&&(d="\\\\\\\\"+d);var e=new RegExp(d,"g");return a=a.replace(e,O),a},O=function(a,b){var c=b.charCodeAt(0);return"~E"+c+"E"}},typeof module!="undefined"&&(module.exports=Showdown),typeof define=="function"&&define.amd&&define("showdown",function(){return Showdown});
/* Miki JS file */
var converter = new Showdown.converter();
document.getElementById("box-content").innerHTML = converter.makeHtml( document.getElementById("text").value ).replace(/\[([^ ]*) (.*?)\]/gi, \'<a href="$1" title="$1">$2</a>\').replace(/\[(.*?)\]/gi, \'<a href="[url]/$1">$1</a>\');';
	private $template = array(
		"page" => '<!DOCTYPE html>
<html>
	<head>
		<title>[title]</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/> 
		<link rel="stylesheet" type="text/css" media="screen" href="[url]/index.php?special=css&v=[version]" />
		<link rel="apple-touch-icon" href="[url]/miki-logo.png" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
		<link rel="shortcut icon" href="[url]/miki-logo.png">
	<head>
	<body>
		<p class="bc">[breadcrumb]</p>
		<div id="box-view">
			<h1 class="title">[filename]</h1>
			<form id="form" action="[url]/index.php?p=[filename]" method="post" class="hide">
				<textarea id="text" name="text">[contentraw]</textarea>
				<input type="submit" value="Save" />
			</form>
			<div id="box-content"></div>
		</div>
		<div id="box-edit" onclick="document.getElementById(\'box-edit\').className=\'hide\';document.getElementById(\'box-content\').className=\'hide\';document.getElementById(\'form\').className=\'\';document.getElementById(\'text\').focus();">
			<p class="edit">Edit</p>
		</div>
		<ul class="allfiles">[allfiles]</ul>
		<script>var miki = {"url":"[url]","version":"[version]"};</script>
		<script type="text/javascript" src="[url]/index.php?special=js&v=[version]"></script>
	</body>
</html>',
	);
	
	
	
	/******************************************************************************************
	 * Magic starts here
	 */
	public function __construct() {
		// Get page
		if (!isset($_GET['p'])) {
			$_GET['p'] = 'welcome';
		// Password protected site?
		}else if (isset($_GET['p']) AND $_GET['p']==$this->apppass) {
			$_SESSION['pass'] = $_GET['p'];
			$_GET['p'] = 'welcome';
		}

		// Password protected page
		if ($this->apppass AND $_SESSION['pass'] != $this->apppass) {
			die('<h1 style="font-size: 1000%;font-family: sans-serif;margin-top: 15%;text-transform: lowercase;letter-spacing: -.05em;text-align: center;color: #C00;text-shadow: 0 2px 10px #CCC;">'.$this->appname.'</h1>');
		}
		
		// CSS file?
		if (isset($_GET['special']) && $_GET['special'] == 'css') {
			header("Expires: ".gmdate("D, d M Y H:i:s", time() + $this->csscachetime)." GMT");
			header("Pragma: cache");
			header("Cache-Control: max-age=".$this->csscachetime);
			header('Content-type: text/css');
			echo $this->css;
			die();
		}
		// JavaScript file?
		if (isset($_GET['special']) && $_GET['special'] == 'js') {
			header("Expires: ".gmdate("D, d M Y H:i:s", time() + $this->csscachetime)." GMT");
			header("Pragma: cache");
			header("Cache-Control: max-age=".$this->csscachetime);
			header('Content-type: application/x-javascript');
			$array = array(
				"url" => $this->url,
				"version" => $this->appversion,
			);
			$output = $this->js;
			foreach ($array as $key => $value) {
				$output = str_replace("[".$key."]", $value, $output);
			}
			echo $output;
			die();
		}
		
		$this->page = preg_replace("[^a-z0-9\-]", "", strtolower($_GET['p']));
		
		// Editing page?
		if (isset($_POST['text']) AND $this->page) {
			$this->savefile($this->page, $_POST['text']);
			$this->gotofile($this->page);
		}
		
		// Load page
		if (!$this->page) {
			if (!$this->is_file_created('welcome')) {
				$this->createfile('welcome', "This is the ''Welcome'' file, *Edit* this file to start.");
			}
			$this->gotofile('welcome');
		}else{
			$this->update_breadcrumb($this->page);
			echo $this->view($this->page);
		}
	}
	
	
	
	/******************************************************************************************
	 * Returns an array of the files
	 */
	private function listfiles() {
		// display only in welcome page
		if ($_GET['p'] != 'welcome') {return;}


		$files = array();
		$allfiles = scandir($this->apppath.'/');
		foreach ($allfiles as $allfile) {
			if ( substr($allfile, -(strlen($this->extension)+1)) == ".".$this->extension ) {
				array_push($files, $allfile);
			}
		}
		$files = $this->arraytoli($files);
		return $files;
	}
	// Converts the array into a <li> list
	private function arraytoli($array) {
		$output = '';
		foreach ($array as $item) {
			$name = substr($item, 0, -4);
			$output .= '<li><a href="'.$this->url.'/'.$name.'">'.$name.'</li>';
		}
		return $output;
	}
	
	
	
	/******************************************************************************************
	 * Generate the View
	 */
	private function view($filename) {
		$output = $this->template['page'];
		$array = array(
			"title" => $filename." - ".$this->appname,
			"filename" => $filename,
			"contentraw" => $this->loadfile($filename),
			"appname" => $this->appname,
			"url" => $this->url,
			"version" => $this->appversion,
			"breadcrumb" => $this->get_breadcrumb(),
			"allfiles" => $this->listfiles(),
		);
		foreach ($array as $key => $value) {
			$output = str_replace("[".$key."]", $value, $output);
		}
		return $output;
	}



	/******************************************************************************************
	 * Create the file
	 */
	private function savefile($filename, $text = '') {
		if ($text) {
			$filename = strtolower(preg_replace("[^A-Za-z0-9\-]", "", $filename).".".$this->extension);
			$filehandle = fopen($this->apppath."/".$filename, 'w') or die("Error: Can't create or save files");
			$fwrite = fwrite($filehandle, substr($text, 0, $this->maxlength));
			fclose($filehandle);
			if ($fwrite === false) {
				return $fwrite;
			}else{
				return true;
			}
		}else{
			// no text, delete file
			if (file_exists(preg_replace("[^A-Za-z0-9\-]", "", $filename).".".$this->extension)) {
				unlink($this->apppath."/".preg_replace("[^A-Za-z0-9\-]", "", $filename).".".$this->extension);
			}
		}
	}
	
	
	
	/******************************************************************************************
	 * Load contents of a file
	 */
	private function loadfile($filename) {
		if (file_exists(preg_replace("[^A-Za-z0-9\-]", "", $filename).".".$this->extension)) {
			return file_get_contents(preg_replace("[^A-Za-z0-9\-]", "", $filename).".".$this->extension);
		}else{
			return '';
		}
	}
	
	
	/******************************************************************************************
	 * Redirects to the specified file
	 */
	private function gotofile($filename) {
		header("Location: ".$this->url."/".strtolower($filename)."/");
	}	
	
	
	/******************************************************************************************
	 * Check if file has been created
	 */
	private function is_file_created($filename) {
		if (file_exists(strtolower($filename).'.'.$this->extension)) {
			return true;
		}else{
			return false;
		}
	}
	
	
	
	
	
	/******************************************************************************************
	 * Update the breadcrumb
	 */
	private function update_breadcrumb($filename) {
		if (!isset($_SESSION['breadcrumb'])) {$_SESSION['breadcrumb'] = array();}
		
		if (!in_array($filename, $_SESSION['breadcrumb'])) {
			$_SESSION['breadcrumb'] = array_merge(array($filename), $_SESSION['breadcrumb']);
		}
		if (sizeof($_SESSION['breadcrumb'])>10) {
			$_SESSION['breadcrumb'] = array_slice($_SESSION['breadcrumb'], 9);
		}
	}

	/******************************************************************************************
	 * Update the breadcrumb
	 */
	private function get_breadcrumb() {
		$output = '';
		// Don't show last one (current)
		$breadcrumb = $_SESSION['breadcrumb'];
		$output = '<a class="start" href="'.$this->url.'/welcome" title="Home">miki</a> &nbsp; &nbsp; '; // home icon &#8962;
		foreach ($breadcrumb as $crumb) {
			$output = $output.'<a href="'.$this->url.'/'.$crumb.'" title="'.$crumb.'">'.$crumb.'</a> &nbsp; &nbsp; ';
		}
		
		return $output;
	}


	
}
$m = new Miki;
